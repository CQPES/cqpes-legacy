# CQPES Legacy

This package is a Python implementation of potential energy surface (PES) fitting with permutational invariant polynomials neural network (PIP-NN).

## Installation

Here is an environment file `env.yml` inside the main directory, simply use the command below to create a conda virtual environment.

```bash
$ conda env create -n cqpes-env -f env.yml
```

## Usage

Before starting the tutorial, make sure the virtual environment has been activated.

```bash
$ conda activate cqpes-env
```

### 1. Generate PIP basis

To remove the barrier of generating PIP basis, a wrapper of MSA-2.0 by Bowman's group is available. First, clone the repo and get into the directory.

```bash
$ git clone https://github.com/CQPES/PyMSA-Builder.git
$ cd PyMSA-Builder
```

The structure of the directory looks like

```bash
$ tree
.
├── build.py
├── LICENSE
├── README.md
└── src
    ├── derivative_c.pl
    ├── derivative.pl
    ├── postemsa_c.pl
    └── postemsa.pl

1 directory, 7 files
```

Then type this command to generate the PIP basis via interactive options

```bash
$ python3 build.py
Cloning into 'MSA-2.0'...
remote: Enumerating objects: 141, done.
remote: Counting objects: 100% (94/94), done.
remote: Compressing objects: 100% (91/91), done.
remote: Total 141 (delta 52), reused 7 (delta 3), pack-reused 47
Receiving objects: 100% (141/141), 188.23 KiB | 606.00 KiB/s, done.
Resolving deltas: 100% (67/67), done.
--------------------------------------------------------------------------------
Building executable `msa`...
rm -rf *~  *.o  msa 
g++ -O2 -Wall -c msa.cpp -I ./header;
g++ -O2 -Wall -c monomial.cpp -I ./header;
g++ -O2 -Wall -c polynomial.cpp -I ./header;
g++ -O2 -Wall -o msa msa.o monomial.o polynomial.o -I ./header; 
--------------------------------------------------------------------------------
Build Python module? [Y/n]
Generate C code? [Y/n]
Build settings:
- Fortran code will be generated by default.
- Python module will be built via `f2py`.
--------------------------------------------------------------------------------
```

Type `Y` then `enter`, or `enter` to build a Python module, then `n` for C code since this has not been implemented yet. 

```bash
Molecule configuration: 4 1
Max degree of PIP: 4
Range parameter alpha for Morse-like variable (default 2.0): 1.0
PIP settings:
- Molecule configuration: 4 1
- Max degree: 4
- Range parameter alpha: 1.0
--------------------------------------------------------------------------------
```

In this example, we will train the PES of  H<sub>2</sub> + H<sub>2</sub>O system, the order of atoms in the raw data `xyz` file is `H H H H O`, i.e. A<sub>4</sub>B. The max degree of PIP should be at least greater or equal than 4. The range parameter $alpha$ determines the long-range fitting ability and 1.0 Angstrom is enough.

```bash
Generating PIP basis...
Generating Fortran code...
Building Python module...
To test Python module `msa`, run command:
$ python3 -c "from msa import basis, gradient;print(basis.__doc__); print(gradient.__doc__)"
Please check the output if any error exists!
--------------------------------------------------------------------------------
Done!
```

If there is nothing wrong, PIP basis will be generated and Python module will be built. 

```bash
$ tree -L 2
.
├── basis
│   ├── MOL_4_1_4.BAS
│   ├── MOL_4_1_4.FOC
│   ├── MOL_4_1_4.MAP
│   ├── MOL_4_1_4.MONO
│   └── MOL_4_1_4.POLY
├── build.py
├── fortran
│   ├── basis.f90
│   ├── gradient.f90
│   └── msa.pyf
├── LICENSE
├── MSA-2.0
│   ├── geom.inp
│   ├── msa.py
│   ├── param.inp
│   ├── README.md
│   ├── reset
│   ├── src
│   └── Tutorial.txt
├── python
│   └── msa.cpython-39-x86_64-linux-gnu.so
├── README.md
└── src
    ├── derivative_c.pl
    ├── derivative.pl
    ├── postemsa_c.pl
    └── postemsa.pl

6 directories, 22 files
```

The PIP basis of A<sub>4</sub>B system can be found in `fortran` directory and the Python wrapper module is in `python` directory.

### 2. Prepare data

The data for training PES should be stored in standard `xyz` format. An `xyz` file can contains several frames of molecules, and for each frame,

1. A line containing the number of atoms
2. A comment line, which can be used to store the energy of current configuration, in **Hartree**
3. The Cartesian coordinates of current configuration, in **Angstrom**

```
5

C	          0.00000000           0.00000000           0.00000000
H	          1.08594333           0.00000000           0.00000000
H	         -0.36198111           0.51191859          -0.88666901
H	         -0.36198111          -1.02383719           0.00000000
H	         -0.36198111           0.51191859           0.88666901
```

For the potential energy, simply write the data into a plain text file. Make sure there is only one piece of energy data in each line, and the potential energy should be in **Hartree**.

Here exists a dataset of CH<sub>4</sub> molecule in directory [`rawdata`](https://github.com/CQPES/cqpes-legacy/tree/main/rawdata).

To prepare the data for training, configurations should be given in a json file like [`config/prepare.json`](https://github.com/CQPES/cqpes-legacy/blob/main/config/prepare.json).

```json
{
    "xyz": "/home/jhli/CQPES-legacy/rawdata/CH4.xyz",
    "energy": "/home/jhli/CQPES-legacy/rawdata/CH4_CCSD-T.dat",
    "ref_energy": null,
    "alpha": 1.0,
    "output": "/home/jhli/CQPES-legacy/data"
}
```

The `xyz` and `energy` has been mentioned before.

For `ref_energy`, the potential energy `V` (in eV) will be calculated by

```
V = (E - E_ref) * 27.2107
```

Usually, for mono molecular system, `ref_energy` can be the energy of stationary point, while for reaction / interaction system, `ref_energy` can be the energy of all species separated far enough.

`alpha` is the range parameter in Morse-like transformation, commonly, it should be 1.0.

`output` indicates the directory to store pre-processed data, in which all data will be stored in numpy `*.npy` format.

Run `./prepare.sh` to prepare the data by your own.

### 3. Train a PES

### 4. Evaluation

### 5. Python Interface

### 6. Fortran Interface

## Reference
